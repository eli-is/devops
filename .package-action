# B"H

name: Build and Packege

on:
  workflow_dispatch:

env:
  IMAGE: go-http-server
  REGISTRY: smuel770

jobs:
  build-publish:
    name: Build, Publish
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - run: |
        git fetch --deepen 20
        cat static/log-style.html > static/log.html && git log  --max-count 20 --pretty=format:"  %+d &nbsp;&nbsp;&nbsp;&nbsp;- %H %s <br>" >> static/log.html

    # helper for authentication
    - run: |-
        docker login -u ${{ secrets.DOCKERHUB_USER }} -p ${{ secrets.DOCKERHUB_PASSWORD }}

    # Build the Docker image
    - name: Build
      run: |-
        docker build \
          --tag "$REGISTRY/$IMAGE:$GITHUB_SHA" \
          --build-arg GITHUB_SHA="$GITHUB_SHA" \
          --build-arg GITHUB_REF="$GITHUB_REF" \
          .

    # Tag the Docker image
    - name: Tag
      run: |-
        docker tag \
          "$REGISTRY/$IMAGE:$GITHUB_SHA" "$REGISTRY/$IMAGE:latest"

    # Push the Docker image to Google Container Registry
    - name: Publish
      run: |-
        echo $IMAGE_DIGEST
        docker push "$REGISTRY/$IMAGE:$GITHUB_SHA"
        docker push "$REGISTRY/$IMAGE:latest"